# CLINK Manage Specification

## Overview

CLINK Manage defines a protocol for delegated management of wallet resources by external applications. Using a bech32-encoded pointer (`nmanage1...`), users can grant external applications specific, auditable rights to manage resources (such as offers) on their wallet server. The protocol is extensible: this document defines the general framework and the first managed resource (offers).

## Motivation

Many Lightning and Nostr use-cases require apps to manage resources on behalf of a user, but only within tightly defined boundaries. CLINK Manage provides a secure, extensible, and Nostr-native way to grant and audit such permissions, starting with offer management for marketplaces, SaaS, and other dynamic pricing scenarios.

## Pointer Format

A CLINK Manage pointer is a bech32-encoded string (per [NIP-19](https://github.com/nostr-protocol/nips/blob/master/19.md)) prefixed with `nmanage1`. The encoded TLVs are:
- `0`: 32-byte pubkey of the user's wallet server (hex encoded)
- `1`: recommended relay URL
- `2`: (optional) pointer ID (for multi-account, etc.)

## Nostr Events

- **Kind:** 21003 (CLINK Management Delegation)
- **Tags:**
  - `["p", "<wallet_server_pubkey>"]`
  - `["clink_version", "1"]`
  - `["e", "<request_event_id>"]` (in responses)
- **Content:** NIP-44 encrypted JSON payload

## Managed Resources

### Offers (`offer`)

Allows an app to create, update, and delete offers on the user's wallet server.

#### Request Payloads
- **Create Offer**
  ```json
  {
    "resource": "offer",
    "action": "create",
    "offer": {
      "label": "Product X",
      "price_sats": 12345,
      "callback_url": "https://example-marketplace.app/callback/123",
      "payer_data": ["email", "shipping_address"]
    }
  }
  ```
- **Update Offer**
  ```json
  {
    "resource": "offer",
    "action": "update",
    "offer": {
      "id": "<offer_id>",
      "fields": {
        "label": "Updated Product X",
        "price_sats": 23456,
        "callback_url": "https://example-marketplace.app/callback/123",
        "payer_data": ["email", "shipping_address"]
      }
    }
  }
  ```
- **Delete Offer**
  ```json
  {
    "resource": "offer",
    "action": "delete",
    "offer": {
      "id": "<offer_id>"
    }
  }
  ```

The offer object is managed by the wallet server. It includes a unique `id` (generated by the server on creation) and may include the following fields: a human-readable `label` for display purposes (this is the standardized, optional field for this purpose), a `price_sats`, a `callback_url`, and a `payer_data` array listing required payer-supplied data fields.

#### Response Payloads
- **Success**
  ```json
  { "res": "ok", "resource": "offer", "details": { /* full offer object */ } }
  ```
  The `details` field contains the full offer object as returned by the wallet server, including the new server-generated `id`. Example:
  ```json
  {
    "id": "<offer_id>",
    "label": "Product X",
    "price_sats": 12345,
    "callback_url": "https://example-marketplace.app/callback/123",
    "payer_data": ["email", "shipping_address"],
    "noffer": "<bech32 offer pointer>"
  }
  ```

- **Error (GFY)**
  ```json
  { "res": "GFY", "code": 1, "error": "Reason" }
  ```

## GFY (General Failure to Yield) Handling

When a request cannot be fulfilled, the wallet service MAY respond with a GFY error code.

**GFY Codes:**

- `1`: Request Denied (User or rule denied the request; may precede reporting)
- `2`: Temporary Failure (Wallet service issue, e.g., node offline)
- `3`: Expired Request (Request timestamp too old, e.g., >30s delta)
- `4`: Rate Limited (Requestor sending too many requests)
- `5`: Invalid Field/Value (e.g., a field is out of range)
- `6`: Invalid Request (Malformed payload, missing fields, etc.)

**GFY Response Payload Structure (Decrypted `content`):**
```json
{
  "res": "GFY",
  "code": <gfy_code>,
  "error": "<human_readable_error_message>"
  // Additional fields based on code (see below)
}
```

**Expected Payloads for Specific GFY Codes:**

1.  **Code 1 (Request Denied):**
    ```json
    {"res": "GFY", "code": 1, "error": "Request Denied"}
    ```
2.  **Code 2 (Temporary Failure):**
    ```json
    {"res": "GFY", "code": 2, "error": "Temporary Failure: <reason>"}
    ```
3.  **Code 3 (Expired Request):**
    ```json
    {
      "res": "GFY", "code": 3, "error": "Expired Request",
      "delta": {"max_delta_ms": 30000, "actual_delta_ms": <calculated_delta>}
    }
    ```
4.  **Code 4 (Rate Limited):**
    ```json
    {
      "res": "GFY", "code": 4, "error": "Rate Limited",
      "retry_after": <unix_timestamp>
    }
    ```
5.  **Code 5 (Invalid Field/Value):**
    ```json
    {
      "res": "GFY", "code": 5, "error": "Invalid Field/Value",
      "field": "price_sats", "range": { "min": 1000, "max": 1000000 }
    }
    ```
6.  **Code 6 (Invalid Request):**
    ```json
    {"res": "GFY", "code": 6, "error": "Invalid Request: <reason>"}
    ```

#### Authorization & Ownership
- The wallet server MUST track which app created each offer and MUST reject modification or deletion requests from other apps unless explicitly permitted by the user.
- Offer IDs MUST be unique per wallet server. The wallet server is responsible for enforcing uniqueness.

#### Updatable Fields
- Only valid fields for an offer may be included in the `fields` object for updates.

#### Authorization Flow
- User shares their `nmanage1...` pointer with the app.
- App sends a Kind 21003 request to the wallet server.
- Wallet server prompts user for approval (or applies rules).
- On approval, the server creates/updates/deletes the offer and responds.

#### Security & Rules
- All requests are signed and auditable.
- Wallet server can enforce rules (e.g., only allow certain apps, require user approval, limit offer creation rate, etc.).
- Apps should not be able to modify or delete offers they did not create, unless explicitly permitted.

## Extensibility

New managed resources can be proposed and added using the same pointer and event kind, with a new `resource` value in the payload. Each resource should define its own payload structure, actions, and security considerations.

## Versioning

### Protocol Versioning

CLINK events utilize a mandatory `["clink_version", "1"]` tag. This ensures:
1.  **Disambiguation:** Explicitly identifies events belonging to the CLINK protocol, preventing conflicts if other NIPs use the same event kind (`21003`).
2.  **Version Compatibility:** Allows clients and services to verify they are using compatible versions of the CLINK protocol specification. Future versions may increment the version number (e.g., `"2"`).

Implementations MUST include this tag in both request and response events and SHOULD reject events lacking this tag or having an unsupported version number.

#### Implementation Notes & FAQ

- **ID Generation**: On `create` actions, the client **MUST NOT** provide an `id`. The wallet server is responsible for generating a unique `id` and returning it in the `details` field of the success response.

- **Idempotency**:
  - `create`: This action is **not** idempotent. A client sending multiple `create` requests (even with identical parameters inside the event `content`) will result in multiple offers being created, as each valid Nostr event is treated as a unique instruction.
  - `update`: This action is idempotent. A client sending multiple `update` requests for the same `id` will result in the same final state. If the offer `id` does not exist, the server MUST return a GFY `6: Invalid Request` error.
  - `delete`: This action is idempotent. A client sending multiple `delete` requests for the same `id` will result in the same final state (the offer not existing). If the offer `id` already does not exist, the server SHOULD return a success (`res: "ok"`) response.

- **Request Expiration**: To prevent replay attacks, wallet servers MUST enforce a maximum time delta between the server's clock and the event's `created_at` timestamp. It is recommended to follow the pattern in CLINK Debits by returning a GFY `3: Expired Request` error for events outside this delta (e.g., > 30 seconds, a standard used by existing implementations).

## Reference Implementations

- **Wallet Node:** [Lightning.Pub](https://github.com/shocknet/Lightning.Pub)
- **Wallet Client:** [ShockWallet](https://shockwallet.app)
- **SDK:** [CLINK SDK](https://github.com/shocknet/ClinkSDK)
- **Demo Client:** [clinkme.dev](https://clinkme.dev/)